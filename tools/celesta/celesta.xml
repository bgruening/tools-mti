<tool id="celesta" name="CELESTA cell typing" version="@TOOL_VERSION@+galaxy@VERSION_SUFFIX@" profile="@PROFILE@">
    <description>Cell type identification with spatial information</description>
    <macros>
        <import>macros.xml</import>
    </macros>
    <expand macro="celesta_requirements"/>
    <expand macro="macro_stdio" />
    <version_command>echo "@VERSION@"</version_command>
    <command detect_errors="aggressive">
        <![CDATA[
        #if str($runmode.selected_mode) == "assign_cells":
            Rscript '$__tool_directory__/celesta_assign_cells.R'
                --imagingdata $anndata
                --prior $prior_info
                --xcol $x_coord
                --ycol $y_coord  
                --maxiteration $max_iteration
                --changethresh $cell_change_threshold  
        #if {$filter_cells.filter} == "filter"
                --filter
                --lowfilter $low_threshold
                --highfilter $high_threshold
        #end if
                ;

        #for $p in $plot_cells:
            Rscript '$__tool_directory__/celesta_plot_cells.R'
                --prior $prior_info
                --celltypes '${p.cell_types}'
                --size $p.test_size ;
        #end for
        #end if
        ]]>
    </command>
    <configfiles>
        <inputs name="inputs" />
    </configfiles>
    <inputs>
        <param name="anndata" type="data" format="h5ad" label="Input anndata" />
        <param name="prior_info" type="data" format="csv" label="Cell-type signature matrix" />
        <conditional name="runmode">
            <param name="selected_mode" type="select" label="Select which CELESTA mode to run">
                <option value="plot_expression" selected="true">Calculate and plot expression probabilities for each marker in the cell type signature matrix</option>
                <option value="assign_cells">Run the cell type assignment</option>
            </param>
            <when value="plot_expression">
                <expand macro="celesta_base_options" label="plot_expression">
                </expand>
            </when>
            <when value="assign_cells">
                <expand macro="celesta_base_options" label="plot_expression">
                </expand>
                <section name="options" title="Advanced Options" expanded="false">
                    <param argument="max_iteration" type="integer" value="10" label="Define the maximum iterations allowed in the EM algorithm per round" />
                    <param argument="cell_change_threshold" type="float" value="0.01" label="Define an ending condition for the EM algorithm" help="0.01 means that when fewer than 1% of the total number of cells do not change identity, the algorithm will stop" />
                    <param name="low_thresholds_file" type="data" format="csv" optional="true" label="Provide a file mapping low anchor and index cell assignment thresholds to cell types" />
                    <param name="high_thresholds_file" type="data" format="csv" optional="true" label="Provide a file mapping high anchor and index cell assignment thresholds to cell types" />
                </section>
                <repeat name="plot_cells" title="Plot combinations of resulting cell type assignments" min="0">
                    <param name="cell_types" type="text" label="Provide a comma-separated list of cell type names to plot together">                    
                        <sanitizer>
                            <valid initial="string.printable"/>
                        </sanitizer>
                    </param>
                    <param argument="test_size" type="integer" value="1" label="Specify the point size for plotting cells" />
                </repeat>
            </when>
        </conditional>
    </inputs>
    <outputs>
        <data name="plot_expression_output" format="png" label="CELESTA plot expression output">
            <filter>runmode['selected_mode'] == "plot_expression"</filter>
        </data>
        <data name="assign_cells_output" format="h5ad" label="CELESTA assign cells output" from_work_dir="result.h5ad" >
            <filter>runmode['selected_mode'] == "assign_cells"</filter>
        </data>
        <collection name="cell_assign_plots" type="list" label="Cell assignment plots">
            <discover_datasets pattern="__name_and_ext__" directory="cell_assign_plots" ext="png" />
            <filter>len(runmode['plot_cells']) != 0</filter>
        </collection>     
    </outputs>
    <tests>
        <test>
            <param name="anndata" value="test.h5ad" />
            <conditional name="runmode">
                <param name="selected_mode" value="assign_cells" />
            </conditional>
            <output name="assign_cells_output">
                <assert_contents>
                    <has_h5_keys keys="obs/cell_type" />
                </assert_contents>
            </output>
        </test>
    </tests>
    <help>
        <![CDATA[
**What it does**

Cell type assignment with CELESTA

**Input**

Inputs!

**Output**

Outputs!


        ]]>
    </help>
    <citations>
    </citations>
</tool>
