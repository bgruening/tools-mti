<tool id="celesta" name="CELESTA cell typing" version="@TOOL_VERSION@+galaxy@VERSION_SUFFIX@" profile="@PROFILE@">
    <description>Cell type identification with spatial information</description>
    <macros>
        <import>macros.xml</import>
    </macros>
    <expand macro="celesta_requirements"/>
    <expand macro="macro_stdio" />
    <version_command>echo "@VERSION@"</version_command>
    <command detect_errors="aggressive">
        <![CDATA[
        Rscript '$__tool_directory__/celesta_plot_expression.R'
            --inputs '$inputs'
            --anndata '$anndata'
            --output '$output'

        ]]>
    </command>
    <configfiles>
        <inputs name="inputs" />
    </configfiles>
    <inputs>
        <param name="anndata" type="data" format="h5ad" label="Input anndata" />
        <param name="prior_info" type="data" format="csv" label="Cell-type signature matrix" />
        <conditional name="runmode">
            <param name="selected_mode" type="select" label="Select which CELESTA mode to run">
                <option value="plot_expression" selected="true">Calculate and plot expression probabilities for each marker in the cell type signature matrix</option>
                <option value="assign_cells">Run the cell type assignment</option>
            </param>
            <when value="plot_expression">
                <expand macro="celesta_base_options" label="plot_expression">
                </expand>
            </when>
            <when value="assign_cells">
                <expand macro="celesta_base_options" label="plot_expression">
                </expand>
                <section name="options" title="Advanced Options" expanded="false">
                    <param argument="max_iteration" type="integer" value="10" label="Define the maximum iterations allowed in the EM algorithm per round" />
                    <param argument="cell_change_threshold" type="float" value="0.01" label="Define an ending condition for the EM algorithm" help="0.01 means that when fewer than 1% of the total number of cells do not change identity, the algorithm will stop" />
                    <param name="thresholds_file" type="data" format="csv" optional="true" label="Provide a file mapping anchor and index cell assignment thresholds to cell types" />
                </section>
                <conditional name="plot_cells">
                    <param name="plot_cells" type="select" label="Choose whether to plot resulting cell type assignments">
                        <option value="no_plot" selected="true">Do not generate plots</option>
                        <option value="plot">Plot the resulting cell type assingments</option>
                    </param>
                    <when value="no_plot">
                    </when>
                    <when value="plot">
                        <param name="cell_types" type="text" label="Provide a comma-separated list of cell type names to plot together" />
                        <param argument="test_size" type="integer" value="1" label="Specify the point size for plotting cells" />
                    </when>
                </conditional>
            </when>
        </conditional>
    </inputs>
    <outputs>
        <data name="plot_expression_output" format="png" label="CELESTA plot expression output">
            <filter>"plot_expression" in selected_mode</filter>
        </data>
        <data name="assign_cells_output" format="h5ad" label="CELESTA assign cells output" >
            <filter>"assign_cells" in selected_mode</filter>
        </data>
        <!-- <data name="plot_cells_output" format="png" label="CELESTA plot cells output">
            <filter>"assign_cells" in selected_mode AND plot cells param</filter> 
        </data> -->
    </outputs>
    <tests>
        <test>
            <param name="anndata" value="test.h5ad" />
            <conditional name="runmode">
                <param name="selected_mode" value="assign_cells" />
            </conditional>
            <output name="assign_cells_output">
                <assert_contents>
                    <has_h5_keys keys="obs/cell_type" />
                </assert_contents>
            </output>
        </test>
    </tests>
    <help>
        <![CDATA[
**What it does**

Cell type assignment with CELESTA

**Input**

Inputs!

**Output**

Outputs!


        ]]>
    </help>
    <citations>
    </citations>
</tool>
