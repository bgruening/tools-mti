<tool id="backsub" name="BACKSUB" version="@TOOL_VERSION@+galaxy@VERSION_SUFFIX@" profile="@PROFILE@">

    <description>Autofluorescence subtraction module for sequential immunofluorescene images.</description>

    <macros>
        <import>macros.xml</import>
    </macros>
 
    <expand macro="requirements"/>
    <expand macro="version_cmd"/>

    <command detect_errors="aggressive"><![CDATA[

        @CMD_BEGIN@ 

        ##Supply image
        --root $root

        ##Supply markers
        --markers $markers

        ##Name output image file
        --output out.ome.tiff

        ##Name output markers file
        --marker-output out.tsv

        ##Additional arguments
        #if $adv.pixel_size
        --pixel-size $adv.pixel_size
        #end if

        #if $adv.tile_size
        --tile-size $adv.tile_size
        #end if

        #if $adv.chunk_size
        --chunk-size $adv.chunk_size
        #end if
        
    ]]></command>

    <inputs>
        <param name="root" type="data" format="ome.tiff" optional="false" label="File path to root image file"/>
        <param name="markers" type="data" format="csv" optional="false" label="File path to required markers.csv file"/>
        <section name="adv" title="Advanced Options" expanded="false">
            <param name="pixel_size" type="float" optional="true" label="Pixel size in microns"/>
            <param name="tile_size" type="integer" optional="true" label="Tile size for pyramid generation (default 1024)"/>
            <param name="chunk_size" type="integer" optional="true" label="Chunk size for dask array (e.g for chunksize 1000, the image will be split into 1000x1000 chunks) (default 5000)"/>
        </section>
    </inputs>

    <outputs>
        <data format="ome.tiff" name="output" from_work_dir="out.ome.tiff" label="${tool.name} on ${on_string}: OutputTiff"/>
        <data format="csv" name="marker_output" from_work_dir="out.csv" label="${tool.name} on ${on_string}: OutputMarkers"/>
    </outputs>

    <tests>
        <test expect_num_outputs="2">
            <param name="markers" value="stacked_AF488_FDX1_crop.csv" />
            <param name="root" value="stacked_AF488_FDX1_crop.ome.tiff" />
            <output name="output" value="out.ome.tiff" ftype="ome.tiff">
                <assert_contents>
                    <has_size value="2000000" delta="1900000" />
                </assert_contents>
            </output>
            <output name="marker_output" value="out.csv" ftype="csv">
                <assert_contents>
                    <has_size value="5000" delta="4999" />
                </assert_contents>
            </output>
        </test>
    </tests>
    <help><![CDATA[
--------------------------------------------------------------------------------
BACKSUB: BACKground SUBtraction for multichannel and multicycle images
--------------------------------------------------------------------------------

**MCMICRO's Background autofluorescence subtraction for cyclic imaging data**

**BACKSUB** performs Pixel-by-pixel channel subtraction scaled by exposure times
primarily developed for images produced by the COMET platform and to work within
the MCMICRO pipeline. Main usecase is autuofluorescence subtraction for
multichannel and multicycle images for visualization of images from tissues with
high autofluroescence (FFPE), improved segmentation, and quantification (if the
previous two usecases aren't necessary, downstream subtraction of
autofluorescent signal is encouraged as the script is memory inefficent).

*Visit https://github.com/SchapiroLabor/Background_subtraction/ for the most up-to-date information on BACKSUB.*
    ]]></help>
    <expand macro="citations" />
</tool>
